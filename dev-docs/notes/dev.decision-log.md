---
id: lemvnlo09cw54zczwbgyhvw
title: Decision Log
desc: ""
updated: 1771985134546
created: 1771779490894
---

## Decision Log Template

- Decision:
- Owner:
- Date:
- Why:
- Tradeoffs:
- Follow-up tasks:

## Decisions (Locked for MVP)

### CLI Framework

- Decision: Use Deno standard-library argument parsing (`@std/cli`) with a small
  in-repo command router for `start`, `stop`, `status`, `clean`, and `export`.
  Do not add Cliffy in MVP.
- Owner: Kato engineering
- Date: 2026-02-22
- Why:
  - Command surface is small and stable for MVP.
  - Keeps dependency/supply-chain risk low and aligned with
    `dev.security-baseline` non-stdlib justification rules.
  - Supports strict command grammar defaults without framework indirection.
- Tradeoffs:
  - No autogenerated command help/completions from a full CLI framework.
  - We own basic usage text, validation, and command dispatch wiring.
- Follow-up tasks:
  - Add `apps/daemon/src/cli/` with parser + command router and tests.
  - Enforce fail-closed behavior for unknown commands/flags.
  - Re-evaluate Cliffy only if command surface/UX needs outgrow in-repo routing.
- MVP defaults:
  - Unknown command or unknown flag is a hard error.
  - No permissive alias behavior unless explicitly added.
  - Strict grammar remains default (legacy permissive parsing stays opt-in
    only).

### Logging Baseline

- Decision: Use an in-repo structured logger facade for MVP (no third-party
  logging package), with JSONL output and separate operational vs security-audit
  sinks.
- Owner: Kato engineering
- Date: 2026-02-22
- Why:
  - Aligns with `dev.security-baseline` requirement to separate security audit
    logs from operational logs.
  - Minimizes external dependencies while behavior is still being shaped.
  - Keeps local-first/no-network behavior simple and deterministic.
- Tradeoffs:
  - We forego advanced transport/rotation features from mature logging
    libraries.
  - We own a small amount of formatting/sink plumbing in daemon code.
- Follow-up tasks:
  - Add `apps/daemon/src/observability/logger.ts` and
    `apps/daemon/src/observability/audit_logger.ts`.
  - Define an event schema/version for log records.
  - Add redaction tests for sensitive fields and audit-completeness tests for
    allow/deny decisions.
- MVP defaults:
  - Format: JSONL.
  - Operational level: `info` (with `debug` opt-in).
  - Security audit events always write to dedicated audit log sink.
  - Operational and audit records remain separated by sink and schema.

### File Watching

- Decision: Use native `Deno.watchFs` with an in-repo debounce/settle utility.
  Do not use `chokidar`.
- Owner: Kato engineering
- Date: 2026-02-22
- Why:
  - `chokidar` is a heavy dependency with deep node-gyp/fsevents roots.
  - Deno's native watcher is sufficient for the MVP scope (local text files).
- Tradeoffs:
  - We must implement our own "write settling" logic (debounce) to handle
    editors that write via temp-rename or multiple flush events.
- Follow-up tasks:
  - Add `apps/daemon/src/core/watcher.ts` with debounce logic.

### Configuration & Parsing

- Decision:
  - Config: Use inline type guards at boundary surfaces (runtime config,
    control-plane payloads, and state parsing). No `zod` in MVP.
  - Keep environment handling Deno-native; no `dotenv` package (use
    `deno --env`).
  - Streams: Use `@std/streams` (`TextLineStream`) for all file processing.
- Owner: Kato engineering
- Date: 2026-02-22
- Why:
  - Leverages Web Standards (Streams) and Deno native features.
  - Inline guards provide fail-closed runtime validation with minimal dependency
    surface.
- Tradeoffs:
  - More manual validation boilerplate than schema-library-driven parsing.
- Follow-up tasks:
  - Re-evaluate `zod` post-MVP if boundary complexity grows substantially.

### Service Mode

- Decision: Defer OS service-manager integration to post-MVP (`systemd`,
  launchd, Windows Service).
- Owner: Kato engineering
- Date: 2026-02-22
- Why:
  - Current development/testing environment is WSL2 and does not provide a
    reliable systemd-capable test target.
  - Service wiring does not block the core MVP capture/export architecture.
- Tradeoffs:
  - Daemon lifecycle remains CLI-managed in MVP rather than OS-native service
    managed.
- Follow-up tasks:
  - Revisit service-manager integration after core daemon interfaces are stable
    and Linux-native test coverage is available.

### OpenFeature

- Decision: Include OpenFeature in MVP from the start.
- Owner: Kato engineering
- Date: 2026-02-22
- Why:
  - Establishes a stable feature-evaluation contract early, avoiding a second
    rollout later.
  - Aligns with future centralized config and cross-app policy control.
- Tradeoffs:
  - Adds up-front integration effort and a small amount of initial abstraction
    overhead.
- Follow-up tasks:
  - Define feature flag contract in `shared/src/contracts/config.ts`.
  - Add a local/offline provider default for MVP and keep network dependency
    optional.
  - Add tests for deterministic fallback behavior when remote flag providers are
    unavailable.

### Step 4 Config/OpenFeature Baseline

- Decision:
  - Add typed `featureFlags` to runtime config contract.
  - Validate runtime config with fail-closed behavior, including rejection of
    unknown feature flag keys.
  - Keep OpenFeature MVP provider local/in-memory only (no network dependency).
- Owner: Kato engineering
- Date: 2026-02-23
- Why:
  - Locks a stable feature-evaluation contract early for daemon/web/cloud
    evolution.
  - Prevents permissive startup behavior on malformed or unrecognized config.
  - Keeps local-first reliability and deterministic behavior for MVP.
- Tradeoffs:
  - Older daemon builds will refuse newer configs with unknown flags until
    versions align.
  - Minimal local provider lacks targeting/rollout features (intentionally
    deferred).
- Follow-up tasks:
  - Add explicit versioning/migration strategy for feature flags beyond MVP.
  - Revisit remote/centralized flag provider once cloud control-plane is active.

### Step 4 Daemon Startup Hardening

- Decision:
  - Introduce fail-closed subprocess startup path that loads runtime config
    before entering runtime loop.
  - Runtime subprocess exits non-zero on config load/validation failure.
- Owner: Kato engineering
- Date: 2026-02-23
- Why:
  - Prevents daemon from running with implicit defaults when config is
    missing/corrupt.
  - Aligns startup semantics with security baseline and documented fail-closed
    policy.
- Tradeoffs:
  - Startup will fail for recoverable config mistakes until user runs explicit
    correction/init flow.
- Follow-up tasks:
  - Add CLI diagnostic tooling for config validation (`kato config validate`)
    post-MVP.
  - Add schema migration helpers when config schema evolves.

### Step 4 Export Loader Contract

- Decision:
  - Add provider-aware loader hook (`loadSessionSnapshot`) to runtime export
    handling, returning `{provider, events}`.
  - Legacy `loadSessionMessages` hook removed in event-native refactor.
- Owner: Kato engineering
- Date: 2026-02-23 (revised 2026-02-24)
- Why:
  - Provider identity flows cleanly into export/audit paths.
  - Event-native payload is the canonical snapshot format (schema v2).
- Tradeoffs:
  - Breaking change from message-centric to event-centric; no migration for in-flight v1 data (none persisted).
- Follow-up tasks:
  - Ensure provider/session source-of-truth is documented for runtime and audit consumers.

### Event-Native Conversation Schema (v2)

- Decision:
  - Replace `Message[]` with `ConversationEvent[]` as canonical runtime session
    state. No backward compatibility with message-only schema required.
  - Events are typed discriminated unions (`message.user`, `message.assistant`,
    `tool.call`, `tool.result`, `thinking`, `decision`, `provider.info`, etc.).
  - `conversationSchemaVersion: 2` stamped on every `RuntimeSessionSnapshot`.
  - Event dedupe signature includes `kind` to prevent cross-kind collisions.
  - Markdown rendering is a projection from events, not from canonical storage.
  - JSONL export (one event JSON per line) added alongside markdown default.
  - `captureIncludeSystemEvents` feature flag gates `message.system` and
    `provider.info` visibility in export/render (default: false).
- Owner: Kato engineering
- Date: 2026-02-24
- Why:
  - Message-centric model could not represent tool calls, thinking, decisions,
    or provider metadata without lossy embedding in content strings.
  - First-class events enable structured export, decision tracking, and
    per-event metadata without hacks.
  - Gemini provider can be built directly on this schema without migration.
- Tradeoffs:
  - All parsers and ingestion wiring required simultaneous refactor.
  - CLI and tests required comprehensive updates.
  - `request_user_input` questionnaire synthesis is approximated (format not
    fully documented; tested with inference).
- Follow-up tasks:
  - Add `request_user_input` fixture under `tests/fixtures/` for explicit
    questionnaire→decision test coverage.
  - Add explicit cross-kind collision test.
  - Add schema fail-closed check for persisted snapshot files (once persistence
    is added).
  - Build Gemini provider runner using this event model directly.

### Gemini Text Source Precedence

- Decision:
  - For Gemini `message.user`, prefer `displayContent` and preserve missing
    command-like lines from raw `content`.
  - For Gemini `message.assistant`, prefer raw `content` and fall back to
    `displayContent` only when `content` is absent.
- Owner: Kato engineering
- Date: 2026-02-25
- Why:
  - User `displayContent` better matches what operators see in Gemini UI and
    avoids raw payload noise.
  - Assistant raw `content` is the authoritative/full text; `displayContent`
    can omit narration/action lines that are relevant for faithful capture.
  - Preserving command-like lines from raw user `content` keeps `::record` and
    `::capture` detection reliable.
- Tradeoffs:
  - Different precedence rules for user vs assistant messages add parser
    complexity.
  - Raw assistant `content` may include text that UI-softened `displayContent`
    would not show.
- Follow-up tasks:
  - Keep regression fixtures/tests for both mismatch cases:
    - user command line present only in raw `content`
    - assistant narration present only in raw `content`
  - Revisit this mapping if upstream Gemini schema semantics change.

### LogLayer Adoption (Phase 1 Parity)

- Decision:
  - Keep `StructuredLogger` / `AuditLogger` contracts and JSONL record schema
    unchanged.
  - Route logger internals through a LogLayer adapter seam.
  - If npm LogLayer is unavailable/incompatible at runtime, fall back to
    parity JSONL emission without dropping logs.
- Owner: Kato engineering
- Date: 2026-02-25
- Why:
  - Enables incremental LogLayer adoption without destabilizing existing sinks,
    tests, or downstream log consumers.
  - Keeps local/offline behavior deterministic in restricted environments.
- Tradeoffs:
  - Adapter adds dynamic import and compatibility handling complexity.
  - Full LogLayer transport/plugin feature set is not yet guaranteed in all
    runtime environments.
- Follow-up tasks:
  - Add explicit OpenTelemetry plugin wiring and transport configuration once
    environment/network constraints are settled.
  - Add compatibility tests for fallback-vs-native LogLayer execution paths.

### Claude Questionnaire Capture Projection

- Decision:
  - Treat Claude `AskUserQuestion` interactions as first-class canonical events
    by synthesizing `decision` events and a user answer summary message from
    `toolUseResult.answers`.
  - Keep raw `tool.call`/`tool.result` events as-is; decision/message synthesis
    is additive.
- Owner: Kato engineering
- Date: 2026-02-25
- Why:
  - Default markdown rendering excludes tool calls; questionnaire prompts and
    user choices were otherwise effectively invisible in recordings.
  - Decision-native projection keeps MCQ interactions queryable/exportable even
    when tool rendering is disabled.
- Tradeoffs:
  - Synthesized summaries are a projection, not a byte-for-byte provider
    transcript.
  - Mapping depends on current Claude payload shape (`toolUseResult`).
- Follow-up tasks:
  - Keep fixture-backed regression coverage for question + answer synthesis.
  - Add similar decision projection tests for Codex questionnaire flows.

### Runtime Config Bootstrap

- Decision: Add explicit runtime config bootstrap via `kato init`, with optional
  auto-bootstrap on `kato start` controlled by `KATO_AUTO_INIT_ON_START`
  (default `true`).
- Owner: Kato engineering
- Date: 2026-02-22
- Why:
  - Preserves `stenobot`-style first-run ergonomics while keeping explicit
    config materialized on disk.
  - Keeps startup behavior deterministic for CLI, daemon launch paths, and
    path-policy configuration.
- Tradeoffs:
  - Adds one additional CLI command and config lifecycle surface.
  - Auto-bootstrap behavior can mask missing manual setup unless disabled.
- Follow-up tasks:
  - Expand runtime config contract in Step 4 with OpenFeature/provider settings.
  - Add boundary validation hardening for config overrides and invalid schema
    migration paths.

### Writer Identity And Command Semantics

- Decision:
  - Use generated `recordingId` per recording stream (not provider `sessionId`),
    so one session can drive multiple recordings.
  - Preserve `::record` and `::capture` as distinct behaviors:
    - `::record`: ongoing stream append target.
    - `::capture`: one-shot snapshot export that does not replace active
      recording stream.
- Owner: Kato engineering
- Date: 2026-02-22
- Why:
  - `stenobot` behavior depends on `record` vs `capture` distinction.
  - Session IDs are provider identities and should not collapse multiple
    destination streams.
- Tradeoffs:
  - Adds routing/state complexity in writer orchestration (stream identity +
    session identity).
  - Requires explicit tests to avoid accidental conflation.
- Follow-up tasks:
  - Add writer routing contract for
    `(provider, sessionId) -> active recording streams`.
  - Add tests for multiple recording streams per session and
    capture-without-rotation behavior.

### Frontmatter ID Format

- Decision: Use compact frontmatter IDs for user-facing note files:
  `<slug>-<randomSuffix>` using an in-repo utility (no extra dependency).
- Owner: Kato engineering
- Date: 2026-02-22
- Why:
  - Better readability in note-centric workflows than full UUIDs.
  - Keeps dependency surface minimal while satisfying uniqueness/readability
    needs.
- Tradeoffs:
  - ID slug may drift from filename after renames; accepted for MVP.
  - Compact suffix has higher (still low) collision risk vs UUID; must size
    suffix accordingly.
- Follow-up tasks:
  - Implement local slug+suffix ID utility and collision tests.
  - Keep runtime/internal IDs on `crypto.randomUUID()` unless explicitly
    user-facing.

### Rich Session Status Model

- Decision:
  - Extend `DaemonStatusSnapshot` with `sessions?: DaemonSessionStatus[]`,
    replacing provider-aggregate-only status for `kato status` output.
  - `DaemonSessionStatus` fields: `provider`, `sessionId`, `snippet?`,
    `updatedAt`, `lastMessageAt?`, `stale`, `recording?`.
  - `DaemonRecordingStatus` fields: `outputPath`, `startedAt`, `lastWriteAt`.
  - Add `kato status --all` (show stale sessions) and `kato status --live`
    (periodic refresh-loop display, TTY-only, 2s interval, 5-session cap).
  - Text and JSON output have full parity: same fields in both modes.
  - Shared projection logic in `shared/src/status_projection.ts` reused by
    daemon, CLI, and web.
- Owner: Kato engineering
- Date: 2026-02-24
- Why:
  - Previous status output only showed aggregate counts; operators could not see
    which sessions were recording or where output was going.
  - Web (`kato-status-web`) and CLI share identical filtering/sorting logic by
    using shared helpers instead of duplicating staleness thresholds.
- Tradeoffs:
  - `sessions` is additive/optional on snapshot; old status files remain valid.
  - `DaemonStatusSnapshot.providers` aggregate kept for backward compatibility.
- Follow-up tasks:
  - Remove legacy `providers` aggregate when all consumers use `sessions`.
  - Add `--interval` and `--count` flags for live mode if needed.

### File Mtime as Primary Staleness Signal

- Decision:
  - Use `fileModifiedAtMs` (OS-level file mtime from `Deno.stat()`) as the
    primary staleness signal for session status, preferred over `lastEventAt`.
  - `lastEventAt` is a fallback. If neither is available, session is stale.
  - Do not use `updatedAt` for staleness: it resets to `now()` on every daemon
    restart, making all sessions appear fresh after a restart.
  - Stale threshold: `DEFAULT_STATUS_STALE_AFTER_MS = 5 * 60_000` (5 min),
    defined in `shared/src/status_projection.ts`.
- Owner: Kato engineering
- Date: 2026-02-24
- Why:
  - `lastEventAt` is unreliable for Codex sessions because the Codex parser
    stamps all events with ingestion time, not actual message time.
  - File mtime is provider-agnostic and reflects true last-write time at the OS
    level.
- Tradeoffs:
  - `fileModifiedAtMs` is absent for sessions ingested before this change; those
    fall back to `lastEventAt`.
  - A session with no `lastEventAt` and no `fileModifiedAtMs` is treated as
    stale (fail-safe).
- Follow-up tasks:
  - Fix Codex parser to use actual message timestamps where available.

### Snippet Caching in Snapshot Metadata

- Decision:
  - Compute and cache `snippet` (first non-blank user message, newlines
    stripped, truncated to 60 chars) in `SessionSnapshotStatusMetadata` during
    `upsert()`.
  - Status projection reads `metadata.snippet` directly; events are not accessed
    in the heartbeat or polling hot paths.
- Owner: Kato engineering
- Date: 2026-02-24
- Why:
  - Events are expensive to clone (`structuredClone` on all events per session).
    Caching the snippet eliminates the only reason status projection needed events.
  - With snippet in metadata, `toProviderStatuses` and `toSessionStatuses`
    require only metadata — enabling `listMetadataOnly()` in all hot paths.
- Tradeoffs:
  - Snippet is computed once at ingest, not dynamically re-derived. If the first
    user message changes (edge case: file truncation and re-ingest), snippet
    updates on next upsert.
- Follow-up tasks:
  - None.

### listMetadataOnly() as Hot-Path Replacement for list()

- Decision:
  - Add `listMetadataOnly(): SessionSnapshotMetadataEntry[]` to
    `SessionSnapshotStore` interface (optional method for backward compatibility).
  - `listMetadataOnly()` returns `{ provider, sessionId, metadata }` tuples
    without cloning the events array — O(n sessions) shallow copy only.
  - `processInChatRecordingUpdates` uses `listMetadataOnly()` + mtime comparison
    to skip sessions whose file hasn't changed; fetches full snapshot via `get()`
    only for changed sessions.
  - Heartbeat `toProviderStatuses` and `toSessionStatuses` accept
    `SessionSnapshotMetadataEntry[]` and use `listMetadataOnly()`.
  - `list()` (deep clone) is reserved for shutdown and test harnesses.
- Owner: Kato engineering
- Date: 2026-02-24
- Why:
  - `list()` was calling `structuredClone(snapshot)` for every session every
    1–5 seconds, causing steady `heapUsed` growth (~7 MB/min observed with 53
    sessions / 15,500 events).
  - With snippet cached in metadata, no hot path needs events from `list()`.
- Tradeoffs:
  - `listMetadataOnly()` is optional on the interface; callers must fall back to
    `list()` when it is absent (test harnesses without the method).
  - Events for changed sessions are still cloned once via `get()` in the polling
    path; this is acceptable (only changed sessions, typically 0–1 per poll).
- Follow-up tasks:
  - Track remaining heap growth after these fixes; if still present, profile to
    identify next allocation source.
  - Consider adding idle-time eviction of stale session snapshots to bound total
    snapshot memory (currently deferred per memory-management task).

### Runtime Read Scope From Config

- Decision:
  - Add `providerSessionRoots` to runtime config (`claude`, `codex`).
  - Launch detached daemon with scoped `--allow-read=<roots>` instead of broad
    `--allow-read`.
  - Derive read roots from provider session roots plus
    runtime/control/config/status and allowed write roots.
- Owner: Kato engineering
- Date: 2026-02-23
- Why:
  - Aligns runtime permissions with `dev.security-baseline` read-scope
    requirements for provider parsing.
  - Removes broad read permissions from long-running daemon process.
  - Keeps ingestion root selection explicit and versioned in runtime config.
- Tradeoffs:
  - Config contract gained another required nested field (with legacy backfill
    behavior for old configs).
  - Permission/root mismatches now fail by omission rather than permissive
    fallback.
- Follow-up tasks:
  - Add CLI UX for editing/listing provider session roots.
  - Add a dedicated permission-boundary integration test for read-denied
    provider roots.
